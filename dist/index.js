import R from"node:net";import L from"node:tls";import{createHash as C}from"node:crypto";function I(){let z=new Map;function G(Z,K){let J=z.get(Z);if(!J)J=new Set,z.set(Z,J);return J.add(K),N}function F(Z,K){let J=(...M)=>{Y(Z,J),K(...M)};return G(Z,J)}function Y(Z,K){let J=z.get(Z);if(J){if(J.delete(K),J.size===0)z.delete(Z)}return N}function V(Z,...K){let J=z.get(Z);if(J)for(let M of J)M(...K)}let N={on:G,once:F,off:Y,emit:V};return N}function U(z){let G=0;for(let V of z)G+=V.length;let F=new Uint8Array(G),Y=0;for(let V of z)F.set(V,Y),Y+=V.length;return F}function B(z){if(z<128)return new Uint8Array([z]);if(z<16384)return new Uint8Array([z>>8|128,z&255]);if(z<2097152)return new Uint8Array([z>>16|192,z>>8&255,z&255]);if(z<268435456)return new Uint8Array([z>>24|224,z>>16&255,z>>8&255,z&255]);return new Uint8Array([240,z>>24&255,z>>16&255,z>>8&255,z&255])}function k(z){let F=new TextEncoder().encode(z),Y=B(F.length);return U([Y,F])}function w(z,G=0){if(G>=z.length)return null;let F=z[G];if(!F||F===0)return{length:0,bytes:1};if((F&128)===0)return{length:F,bytes:1};if((F&192)===128)return{length:(F&63)<<8|(z[G+1]??0),bytes:2};if((F&224)===192)return{length:(F&31)<<16|(z[G+1]??0)<<8|(z[G+2]??0),bytes:3};if((F&240)===224)return{length:(F&15)<<24|(z[G+1]??0)<<16|(z[G+2]??0)<<8|(z[G+3]??0),bytes:4};if(F===240)return{length:(z[G+1]??0)<<24|(z[G+2]??0)<<16|(z[G+3]??0)<<8|(z[G+4]??0),bytes:5};return null}function h(z){let G=[],F=0,Y=new TextDecoder;while(F<z.length){let V=[];while(F<z.length){let N=w(z,F);if(!N)return{sentences:G,rest:z.slice(F)};if(F+=N.bytes,N.length===0)break;if(F+N.length>z.length)return{sentences:G,rest:z.slice(F-N.bytes)};let Z=Y.decode(z.slice(F,F+N.length));V.push(Z),F+=N.length}if(V.length>0)G.push(V)}return{sentences:G,rest:new Uint8Array(0)}}function g(z){return z.filter((G)=>G[0]==="!re").map((G)=>G.slice(1).reduce((F,Y)=>{if(Y.startsWith("=")){let[V,...N]=Y.slice(1).split("=");if(typeof V<"u")F[V]=N.join("=")}return F},{}))}function b(z){let G=null,F=I();async function Y(){let{host:K,port:J,ssl:M,timeout:X}={port:z.ssl?8729:8728,timeout:30000,ssl:!1,...z};try{return await new Promise((P,_)=>{try{let Q=M?L.connect({host:K,port:J,timeout:X},()=>P()):R.connect({host:K,port:J,timeout:X},()=>P());G=Q,Q.on("connect",()=>F.emit("connect")),Q.on("error",($)=>{F.emit("error",$),_($)}),Q.on("close",()=>F.emit("close")),Q.on("end",()=>F.emit("end"))}catch(Q){F.emit("error",Q),_(Q)}}),{status:!0,data:void 0}}catch(P){return{status:!1,message:`Failed to connect to ${K}:${J}: ${P.message}`,error:P}}}async function V(K,J){try{let M=await N("/login",{name:K,password:J});if(!M.status){let{message:P,error:_}=M;return{status:!1,message:P,error:_}}let X=M.data.flatMap((P)=>Object.entries(P)).find(([P])=>P==="ret")?.[1];if(X){let P=new Uint8Array(X.match(/.{1,2}/g)?.map((q)=>parseInt(q,16))||[]),_=new TextEncoder().encode(J),Q=new Uint8Array(1+_.length+P.length);Q.set([0],0),Q.set(_,1),Q.set(P,1+_.length);let $=C("md5").update(Buffer.from(Q)).digest(),S="00"+Array.from($).map((q)=>q.toString(16).padStart(2,"0")).join(""),W=await N("/login",{name:K,response:S});if(!W.status){let{message:q,error:x}=W;return{status:!1,message:q,error:x}}return{status:!0,data:void 0}}return{status:!0,data:void 0}}catch(M){return{status:!1,message:`Login failed: ${M.message}`,error:M}}}function N(K,J={}){if(!G)return Promise.resolve({status:!1,message:"Not connected"});return new Promise((M)=>{let X=G,P=[K,...Object.entries(J).map(([O,D])=>`=${O}=${D}`)],_=U([...P.map(k),new Uint8Array([0])]),Q=[],$=new Uint8Array(0),S=(O)=>{let D=new Uint8Array(O);$=U([$,D]);let{sentences:A,rest:j}=h($);$=new Uint8Array(j);for(let T of A){if(T[0]==="!trap"){H(),M({status:!1,message:T.find((E)=>E.startsWith("=message="))?.slice(9)??"Trap error"});return}if(T[0]==="!fatal"){H(),M({status:!1,message:"Fatal error: "+T.slice(1).join(" ")});return}if(Q.push(T),T[0]==="!done"){H(),M({status:!0,data:g(Q)});return}}},W=(O)=>{H(),M({status:!1,message:O.message,error:O})},q=()=>{H(),M({status:!1,message:"Connection closed"})},x=()=>{H(),M({status:!1,message:"Connection ended"})};function H(){X.off("data",S),X.off("error",W),X.off("close",q),X.off("end",x)}X.on("data",S),X.on("error",W),X.on("close",q),X.on("end",x),X.write(Buffer.from(_))})}function Z(){try{return G?.destroy(),F.emit("close"),{status:!0,data:void 0}}catch(K){return F.emit("error",K),{status:!1,message:K.message,error:K}}}return{connect:Y,login:V,runCommand:N,close:Z,on:F.on.bind(F),once:F.once.bind(F),off:F.off.bind(F),getSystemIdentity(){return N("/system/identity/print")}}}export{b as createRouterOSClient,I as createEmitter};

//# debugId=FB6DE6DFF84CEEAB64756E2164756E21
