import E from"node:net";import L from"node:tls";import{createHash as I}from"node:crypto";class S{listeners=new Map;on(q,G){let z=this.listeners.get(q);if(!z)z=new Set,this.listeners.set(q,z);return z.add(G),this}once(q,G){let z=(...M)=>{this.off(q,z),G(...M)};return this.on(q,z)}off(q,G){let z=this.listeners.get(q);if(z){if(z.delete(G),z.size===0)this.listeners.delete(q)}return this}emit(q,...G){let z=this.listeners.get(q);if(z)for(let M of z)M(...G)}}function D(q){let G=0;for(let T of q)G+=T.length;let z=new Uint8Array(G),M=0;for(let T of q)z.set(T,M),M+=T.length;return z}function B(q){if(q<128)return new Uint8Array([q]);if(q<16384)return new Uint8Array([q>>8|128,q&255]);if(q<2097152)return new Uint8Array([q>>16|192,q>>8&255,q&255]);if(q<268435456)return new Uint8Array([q>>24|224,q>>16&255,q>>8&255,q&255]);return new Uint8Array([240,q>>24&255,q>>16&255,q>>8&255,q&255])}function h(q){let z=new TextEncoder().encode(q),M=B(z.length);return D([M,z])}function k(q,G=0){if(G>=q.length)return null;let z=q[G];if(!z||z===0)return{length:0,bytes:1};if((z&128)===0)return{length:z,bytes:1};if((z&192)===128)return{length:(z&63)<<8|(q[G+1]??0),bytes:2};if((z&224)===192)return{length:(z&31)<<16|(q[G+1]??0)<<8|(q[G+2]??0),bytes:3};if((z&240)===224)return{length:(z&15)<<24|(q[G+1]??0)<<16|(q[G+2]??0)<<8|(q[G+3]??0),bytes:4};if(z===240)return{length:(q[G+1]??0)<<24|(q[G+2]??0)<<16|(q[G+3]??0)<<8|(q[G+4]??0),bytes:5};return null}function w(q){let G=[],z=0,M=new TextDecoder;while(z<q.length){let T=[];while(z<q.length){let Q=k(q,z);if(!Q)return{sentences:G,rest:q.slice(z)};if(z+=Q.bytes,Q.length===0)break;if(z+Q.length>q.length)return{sentences:G,rest:q.slice(z-Q.bytes)};let R=M.decode(q.slice(z,z+Q.length));T.push(R),z+=Q.length}if(T.length>0)G.push(T)}return{sentences:G,rest:new Uint8Array(0)}}function g(q){return q.filter((G)=>G[0]==="!re").map((G)=>G.slice(1).reduce((z,M)=>{if(M.startsWith("=")){let[T,...Q]=M.slice(1).split("=");if(typeof T<"u")z[T]=Q.join("=")}return z},{}))}function p(q){let G=null,z=new S;async function M(){let{host:V,port:Z,ssl:N,timeout:P}={port:q.ssl?8729:8728,timeout:30000,ssl:!1,...q};try{return await new Promise((J,X)=>{try{let K=N?L.connect({host:V,port:Z,timeout:P},()=>J()):E.connect({host:V,port:Z,timeout:P},()=>J());G=K,K.on("connect",()=>z.emit("connect")),K.on("error",(Y)=>{z.emit("error",Y),X(Y)}),K.on("close",()=>z.emit("close")),K.on("end",()=>z.emit("end"))}catch(K){z.emit("error",K),X(K)}}),{status:!0,data:void 0}}catch(J){return{status:!1,message:`Failed to connect to ${V}:${Z}: ${J.message}`,error:J}}}async function T(V,Z){try{let N=await Q("/login",{name:V,password:Z});if(!N.status){let{message:J,error:X}=N;return{status:!1,message:J,error:X}}let P=N.data.flatMap((J)=>Object.entries(J)).find(([J])=>J==="ret")?.[1];if(P){let J=new Uint8Array(P.match(/.{1,2}/g)?.map((_)=>parseInt(_,16))||[]),X=new TextEncoder().encode(Z),K=new Uint8Array(1+X.length+J.length);K.set([0],0),K.set(X,1),K.set(J,1+X.length);let Y=I("md5").update(Buffer.from(K)).digest(),W="00"+Array.from(Y).map((_)=>_.toString(16).padStart(2,"0")).join(""),O=await Q("/login",{name:V,response:W});if(!O.status){let{message:_,error:x}=O;return{status:!1,message:_,error:x}}return{status:!0,data:void 0}}return{status:!0,data:void 0}}catch(N){return{status:!1,message:`Login failed: ${N.message}`,error:N}}}function Q(V,Z={}){if(!G)return Promise.resolve({status:!1,message:"Not connected"});return new Promise((N)=>{let P=G,J=[V,...Object.entries(Z).map(([F,A])=>`=${F}=${A}`)],X=D([...J.map(h),new Uint8Array([0])]),K=[],Y=new Uint8Array(0),W=(F)=>{let A=new Uint8Array(F);Y=D([Y,A]);let{sentences:U,rest:j}=w(Y);Y=new Uint8Array(j);for(let H of U){if(H[0]==="!trap"){$(),N({status:!1,message:H.find((C)=>C.startsWith("=message="))?.slice(9)??"Trap error"});return}if(H[0]==="!fatal"){$(),N({status:!1,message:"Fatal error: "+H.slice(1).join(" ")});return}if(K.push(H),H[0]==="!done"){$(),N({status:!0,data:g(K)});return}}},O=(F)=>{$(),N({status:!1,message:F.message,error:F})},_=()=>{$(),N({status:!1,message:"Connection closed"})},x=()=>{$(),N({status:!1,message:"Connection ended"})};function $(){P.off("data",W),P.off("error",O),P.off("close",_),P.off("end",x)}P.on("data",W),P.on("error",O),P.on("close",_),P.on("end",x),P.write(Buffer.from(X))})}function R(){try{return G?.destroy(),z.emit("close"),{status:!0,data:void 0}}catch(V){return z.emit("error",V),{status:!1,message:V.message,error:V}}}return{connect:M,login:T,runCommand:Q,close:R,on:z.on.bind(z),once:z.once.bind(z),off:z.off.bind(z),getSystemIdentity(){return Q("/system/identity/print")}}}export{p as createRouterOSClient};

//# debugId=D8AFB4DA08F2D71364756E2164756E21
